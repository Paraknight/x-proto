"use strict";Number.prototype.mod=function(n){return(this%n+n)%n};var GAME="undefined"!=typeof GAME&&GAME?GAME:{};GAME.namespace=function(){var i,j,d,a=arguments,o=null;for(i=0;i<a.length;i+=1)for(d=(""+a[i]).split("."),o=GAME,j="GAME"==d[0]?1:0;j<d.length;j+=1)o[d[j]]=o[d[j]]||{},o=o[d[j]];return o},GAME.namespace("utils").getRoot=function(){return"https://dl.dropbox.com/u/704818/Escape%20Pod/Games/"},GAME.utils.loadScriptSync=function(url,callback){var script=document.createElement("script");script.async=!1,script.src=url,callback&&(script.onload=callback),document.head.appendChild(script)},GAME.utils.xhrSyncGet=function(url){var xhr=new XMLHttpRequest;return xhr.open("GET",url,!1),xhr.send(),xhr.responseText},GAME.utils.xhrAsyncGet=function(url,callback){var xhr=new XMLHttpRequest;xhr.onload=function(){callback(this.responseText)},xhr.open("GET",url),xhr.send()},GAME.utils.centerElement=function(element){element.style.marginLeft=-parseInt(element.clientWidth)/2+"px",element.style.marginTop=-parseInt(element.clientHeight)/2+"px"},GAME.utils.Countdown=function(from,callback){this.count=from||1,this.callback=callback},GAME.utils.Countdown.prototype.dec=function(){--this.count<=0&&this.callback&&this.callback()},GAME.utils.List=function(){this.size=0},GAME.utils.List.prototype.add=function(element){return element&&(this.tail=this.tail?this.tail.next={e:element}:this.head={e:element},this.size++),this},GAME.utils.List.prototype.remove=function(element){if(element&&this.head){if(this.head===element)return this.head=this.head===this.tail?this.tail=void 0:this.head.next,this.size--,!0;for(var current=this.head;current.next;){if(current.next===element)return current.next===this.tail&&(this.tail=current),current.next=current.next.next,this.size--,!0;current=current.next}}return!1},GAME.utils.List.prototype.poll=function(){var element=this.head?this.head.e:void 0;return element&&(this.head=this.head===this.tail?this.tail=void 0:this.head.next,this.size--),element},GAME.utils.noise={perlin2D:function(seed,x,y){for(var gain=.25,octaves=6,total=0,i=0;octaves>i;i++){var frequency=Math.pow(2,i)/20,amplitude=Math.pow(gain,i);total+=GAME.utils.noise.biLerpedSmoothNoise(seed,x*frequency,y*frequency)*amplitude}return total},perlin3D:function(seed,x,y,z){for(var gain=.25,octaves=4,total=0,i=0;octaves>i;i++){var frequency=Math.pow(2,i),amplitude=Math.pow(gain,i);total+=GAME.utils.noise.triLerpedSmoothNoise(seed,x*frequency,y*frequency,z*frequency)*amplitude}return total},fBm:function(seed,x,y,z){for(var gain=.5,lacunarity=2,frequency=1,amplitude=10,octaves=4,total=0,i=0;octaves>i;i++)total+=GAME.utils.noise.triLerpedSmoothNoise(seed,x*frequency,y*frequency,z*frequency)*amplitude,frequency*=lacunarity,amplitude*=gain;return total},biLerpedSmoothNoise:function(seed,x,y){var xi=Math.floor(x),yi=Math.floor(y),muX=x-xi,muY=y-yi,context=GAME.utils.noise;return context.biLerp(context.smooth2D(seed,xi,yi),context.smooth2D(seed,xi+1,yi),context.smooth2D(seed,xi,yi+1),context.smooth2D(seed,xi+1,yi+1),muX,muY)},triLerpedSmoothNoise:function(seed,x,y,z){var xi=Math.floor(x),yi=Math.floor(y),zi=Math.floor(z),muX=x-xi,muY=y-yi,muZ=z-zi,context=GAME.utils.noise;return context.lerp(context.biLerp(context.smooth3D(seed,xi,yi,zi),context.smooth3D(seed,xi+1,yi,zi),context.smooth3D(seed,xi,yi+1,zi),context.smooth3D(seed,xi+1,yi+1,zi),muX,muY),context.biLerp(context.smooth3D(seed,xi,yi,zi+1),context.smooth3D(seed,xi+1,yi,zi+1),context.smooth3D(seed,xi,yi+1,zi+1),context.smooth3D(seed,xi+1,yi+1,zi+1),muX,muY),muZ)},triLerp:function(cs,muX,muY,muZ){var context=GAME.utils.noise;return context.lerp(context.biLerp(cs[0][0][0],cs[1][0][0],cs[0][1][0],cs[1][1][0],muX,muY),context.biLerp(cs[0][0][1],cs[1][0][1],cs[0][1][1],cs[1][1][1],muX,muY),muZ)},biLerp:function(c00,c10,c01,c11,muX,muY){var context=GAME.utils.noise;return context.lerp(context.lerp(c00,c10,muX),context.lerp(c01,c11,muX),muY)},lerp:function(x0,x1,mu){return x0+(x1-x0)*mu},smooth2D:function(seed,x,y){var context=GAME.utils.noise,corners=(context.noise(seed,x-1,y-1,0)+context.noise(seed,x+1,y-1,0)+context.noise(seed,x-1,y+1,0)+context.noise(seed,x+1,y+1,0))/16,sides=(context.noise(seed,x-1,y,0)+context.noise(seed,x+1,y,0)+context.noise(seed,x,y-1,0)+context.noise(seed,x,y+1,0))/8;return corners+sides+context.noise(seed,x,y,0)/4},smooth3D:function(seed,x,y,z){var context=GAME.utils.noise,edges=(context.noise(seed,x-1,y-1,z)+context.noise(seed,x+1,y-1,z)+context.noise(seed,x-1,y+1,z)+context.noise(seed,x+1,y+1,z)+context.noise(seed,x,y-1,z-1)+context.noise(seed,x-1,y,z-1)+context.noise(seed,x+1,y,z-1)+context.noise(seed,x,y+1,z-1)+context.noise(seed,x,y-1,z+1)+context.noise(seed,x-1,y,z+1)+context.noise(seed,x+1,y,z+1)+context.noise(seed,x,y+1,z+1))/16,corners=(context.noise(seed,x-1,y-1,z-1)+context.noise(seed,x+1,y-1,z-1)+context.noise(seed,x-1,y+1,z-1)+context.noise(seed,x+1,y+1,z-1)+context.noise(seed,x-1,y-1,z+1)+context.noise(seed,x+1,y-1,z+1)+context.noise(seed,x-1,y+1,z+1)+context.noise(seed,x+1,y+1,z+1))/32,sides=(context.noise(seed,x,y-1,z)+context.noise(seed,x-1,y,z)+context.noise(seed,x+1,y,z)+context.noise(seed,x,y+1,z)+context.noise(seed,x,y,z-1)+context.noise(seed,x,y,z+1))/8;return edges+corners+sides+context.noise(seed,x,y,z)/4},noise:function(seed,x,y,z){var n=x+89*y+4173*z+110133*seed;return n=n>>13^n,1-(n*(60493*n*n+19990303)+1376312589)%2147483647/1073741824}},GAME.namespace("net").p2p={send:function(){},join:function(hostID){function on(eventName,eventHandler){eventHandlers[eventName]=eventHandler}var peer=new Peer("Player"+Math.floor(999*Math.random()),{host:"4ytech.com",port:9980,debug:!0}),connection=peer.connect(hostID);connection.on("open",function(){GAME.net.p2p.send=function(){connection.send({event:arguments[0],args:Array.prototype.slice.call(arguments,1)})}});var game=GAME.game,eventHandlers={};connection.on("data",function(data){"event"in data&&data.event in eventHandlers&&eventHandlers[data.event].apply(GAME.net.p2p,data.args)}),connection.on("error",function(error){console.error(error)}),connection.on("close",function(){GAME.gui.log("You've been disconnected from "+connection.peer+".")}),on("state",function(state,userID){if(state.pos=(new THREE.Vector3).fromArray(state.pos),state.rot=(new THREE.Vector3).fromArray(state.rot),userID in game.scene.entityManager.players){var player=game.scene.entityManager.players[userID];player.onStateReceived(state)}else game.scene.entityManager.spawnPlayer(userID,state)}),on("despawn",function(userID){game.scene.entityManager.despawnPlayer(userID)}),on("log",function(packet){GAME.gui.log(packet.msg),packet.mute||GAME.audio.loadSpeech(packet.msg,function(audioElement){var source=new GAME.audio.AudioSourceStreaming(audioElement);source.setPosition(game.camera.localToWorld(new THREE.Vector3)),source.play()},{pitch:100})}),on("chat",function(text,userID){userID=userID||connection.peer,GAME.gui.log(userID+": "+text),GAME.audio.loadSpeech(text,function(audioElement){var source=new GAME.audio.AudioSourceStreaming(audioElement);source.setPosition(game.scene.entityManager.players[userID].position),source.play()})}),on("ping",function(){this.send("pong")})},host:function(){function broadcast(){for(var packet={event:arguments[0],args:Array.prototype.slice.call(arguments,1)},i=0;i<peers.length;i++)peers[i].send(packet)}var host=new Peer("Host",{host:"4ytech.com",port:9980,debug:!0}),peers=[];host.on("connection",function(connection){peers.push(connection),connection.on("open",function(){broadcast("log",{msg:connection.peer+" has joined the game."})}),connection.on("data",function(data){"args"in data&&data.args.push(connection.peer);for(var i=0;i<peers.length;i++)peers[i]!=connection&&peers[i].send(data)}),connection.on("error",function(error){console.error(error)}),connection.on("close",function(){var peerIndex=peers.indexOf(connection);0>peerIndex||(peers.splice(peerIndex,1),broadcast("despawn",connection.peer),broadcast("log",{msg:connection.peer+" has left the game."}))})}),this.join("Host")}},GAME.namespace("gui").init=function(){function createWindow(x,y,w,h){var win=document.createElement("div");return win.className="window draggable",win.style.top=y+"px",win.style.left=x+"px",win.style.width=w+"px",win.style.height=h+"px",overlay.appendChild(win),win}function allowDrop(event){event.preventDefault()}function drag(event){event.dataTransfer.setData("Text",event.target.id)}function drop(event){event.preventDefault();var itemImg=document.getElementById(event.dataTransfer.getData("Text")),destSlot=event.target;destSlot!==itemImg&&destSlot.slot.put(itemImg.item)}GAME.gui.transitionEnd="ontransitionend"in window?"transitionend":"onwebkittransitionend"in window?"webkitTransitionEnd":!1;var overlay=document.getElementById("overlay");GAME.gui.statsTick=new Stats,overlay.appendChild(GAME.gui.statsTick.domElement),GAME.gui.statsRender=new Stats,overlay.appendChild(GAME.gui.statsRender.domElement);var playerWin=createWindow(0|(window.innerWidth-432)/2,0|(window.innerHeight-432)/2,432,432);playerWin.id="playerWin",playerWin.style.display="none";var equip=document.createElement("div"),Slot=function(id,x,y){var div=this.div=document.createElement("div");div.slot=this,div.id="invSlot"+id,div.className="itemSlot",div.style.left=x,div.style.top=y,div.ondrop=drop,div.ondragover=allowDrop};Slot.prototype.setBG=function(url,x,y){return x=x||"0px",y=y||"0px",this.div.style.backgroundImage="url('"+url+"')",this.div.style.backgroundPosition="-"+x+" -"+y,this},Slot.prototype.put=function(item){var sourceSlot=item.img.parentNode;this.div.appendChild(item.img),sourceSlot&&"onRemove"in sourceSlot.slot&&sourceSlot.slot.onRemove(item),"onPut"in this&&this.onPut(item)},Slot.prototype.remove=function(item){this.div.removeChild(item.img),"onRemove"in this&&this.onRemove(item)},equip.appendChild(new Slot(0,"20%","27px").setBG("res/textures/spritesheet.png").div),equip.appendChild(new Slot(1,"20%","81px").setBG("res/textures/spritesheet.png","0px","40px").div);var handSlot=new Slot(2,"20%","135px");handSlot.onPut=function(item){console.log(item)},handSlot.onRemove=function(item){console.log(item)},equip.appendChild(handSlot.div),equip.appendChild(new Slot(3,"20%","189px").div);var inv=document.createElement("div");inv.style.position="absolute",inv.style.bottom=0;for(var i=0;24>i;i++)inv.appendChild(new Slot(8+i,5+54*(i%8)+"px",-149+50*(0|.125*i)+"px").div);playerWin.appendChild(equip),playerWin.appendChild(inv);var Item=function(name,spriteSheetURL,x,y){var img=this.img=document.createElement("img");img.item=this,img.id="itemImg"+name,img.src="res/textures/null.png",img.style.backgroundImage="url('"+spriteSheetURL+"')",img.style.backgroundPosition="-"+x+" -"+y,img.draggable=!0,img.ondragstart=drag};handSlot.put(new Item("axe","res/textures/spritesheet.png","40px","0px"))},GAME.gui.setChatFocus=function(flag,scope){scope.form.console.className=flag?"maxSize fadeIn":"minSize fadeOut",document.getElementById("passiveChat").className=flag?"fadeOut":"fadeIn"},GAME.gui.log=function(text){var clientForm=document.getElementById("clientForm");clientForm.console.value+=text+"\n",clientForm.console.scrollTop=clientForm.console.scrollHeight-clientForm.console.clientHeight;var chatLine=document.createElement("div");chatLine.appendChild(document.createTextNode(text));var passiveChat=document.getElementById("passiveChat");passiveChat.appendChild(chatLine),setTimeout(function(){chatLine.className="fadeOut"},1e4),chatLine.addEventListener(GAME.gui.transitionEnd,function(){passiveChat.removeChild(passiveChat.firstChild)},!1)},GAME.gui.submitConsoleInput=function(form){var text=form.input.value.trim();if(form.input.value="",text.length)if("/"==text.charAt(0)){var input=text.split(" "),cmd=input[0].substring(1),args=input.slice(1);switch(cmd){case"join":args.length>0?GAME.net.p2p.join(args[0]):GAME.gui.log('Join syntax: "/join [HostID]".');break;case"host":GAME.net.p2p.host();break;case"time":args.length>0?GAME.game.time=parseFloat(args[0])%1:GAME.gui.log('Time syntax: "/time [0.0-1.0)".');break;default:GAME.gui.log("Invalid command.")}}else GAME.net.p2p.send("chat",text),GAME.gui.log("You: "+text),GAME.audio.loadSpeech(text,function(audioElement){var source=new GAME.audio.AudioSourceStreaming(audioElement);source.setPosition(GAME.game.camera.localToWorld(new THREE.Vector3)),source.play()})},GAME.namespace("shaders").sky={uniforms:{skyRadius:{type:"f",value:1e3},time:{type:"f",value:0}},vertexShader:["#ifdef GL_ES","precision highp float;","#endif","uniform float skyRadius;","varying vec2 skyUV;","const vec2 fwd = vec2(0.0, -1.0);","void main() {","skyUV = vec2(1.0 - uv.s, uv.t);","gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);","}"].join("\n"),fragmentShader:["#ifdef GL_ES","precision highp float;","#endif","#define PI_2	1.5707963267948966192313216916398","#define PI2		6.2831853071795864769252867665590","#define BLNDEXP	0.4","uniform float time;","varying vec2 skyUV;","const vec4 BLACK		= vec4(0.0, 0.0, 0.0, 0.0);","const vec4 WHITE		= vec4(1.0, 1.0, 1.0, 1.0);","const vec4 SKY_BLUE		= vec4(0.5, 0.8, 1.0, 1.0);","const vec4 DARK_BLUE	= vec4(0.0, 0.0, 0.5, 1.0);","const vec4 BLACK_BLUE	= vec4(0.0, 0.0, 0.2, 1.0);","const vec4 DARK_ORANGE	= vec4(0.75, 0.4, 0.0, 1.0);","vec4 calcSkyCol() {","vec4 col;","float mu = skyUV.y<0.5?0.0:pow(((skyUV.y*2.0)-1.0), BLNDEXP);","if (time < 0.1) {","col = mix(mix(DARK_ORANGE, DARK_BLUE, mu), mix(WHITE, SKY_BLUE, mu), 10.0*time);","col *= 0.5 * min(max(-cos(skyUV.x*PI2), 0.0) * cos(((skyUV.y*2.0)-1.0)*PI_2) + sin(10.0*time*PI_2), 1.0) + 0.5;","} else if (time < 0.4) {","col = mix(WHITE, SKY_BLUE, mu);","} else if (time < 0.5) {","col = mix(mix(WHITE, SKY_BLUE, mu), mix(DARK_ORANGE, DARK_BLUE, mu), 10.0*time-4.0);","col *= 0.5 * min(max(cos(skyUV.x*PI2), 0.0) * cos(((skyUV.y*2.0)-1.0)*PI_2) + cos((10.0*time-4.0)*PI_2), 1.0) + 0.5;","} else if (time < 0.6) {","col = mix(mix(DARK_ORANGE, DARK_BLUE, mu), mix(BLACK_BLUE, BLACK, mu), 10.0*time-5.0);","col *= 0.5 * min(max(cos(skyUV.x*PI2), 0.0) * cos(((skyUV.y*2.0)-1.0)*PI_2) + sin((10.0*time-5.0)*PI_2), 1.0) + 0.5;","} else if (time < 0.9) {","col = mix(BLACK_BLUE, BLACK, mu);","} else {","col = mix(mix(BLACK_BLUE, BLACK, mu), mix(DARK_ORANGE, DARK_BLUE, mu), 10.0*time-9.0);","col *= 0.5 * min(max(-cos(skyUV.x*PI2), 0.0) * cos(((skyUV.y*2.0)-1.0)*PI_2) + cos((10.0*time-9.0)*PI_2), 1.0) + 0.5;","}","return col;","}","void main() {","gl_FragColor = calcSkyCol();","}"].join("\n")},GAME.shaders.terrain={uniforms:{diffuse:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0},bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1},normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)},ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]},shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]},ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)},terrainHeight:{type:"f",value:64},texture0:{type:"t",value:THREE.ImageUtils.loadTexture("./res/textures/tempsand.png",void 0,function(texture){texture.wrapT=texture.wrapS=THREE.RepeatWrapping})},texture1:{type:"t",value:THREE.ImageUtils.loadTexture("./res/textures/grassdark.png",void 0,function(texture){texture.wrapT=texture.wrapS=THREE.RepeatWrapping})},tex0Scale:{type:"f",value:2},tex1Scale:{type:"f",value:4}},vertexShader:["#define PHONG","varying vec3 vViewPosition;","varying vec3 vNormal;","varying vec4 worldCoord;",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_phong_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {","worldCoord = modelMatrix * vec4(position, 1.0);",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"vNormal = normalize(transformedNormal);",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_phong_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform int isDaytime;","uniform float terrainHeight;","uniform sampler2D texture0;","uniform sampler2D texture1;","uniform float tex0Scale;","uniform float tex1Scale;","varying vec4 worldCoord;","const vec4 waterCol = vec4(0.5, 0.5, 0.0, 1.0);","const vec4 sandCol = vec4(1.0, 1.0, 0.0, 1.0);","const vec4 grassCol = vec4(0.0, 1.0, 0.0, 1.0);","const vec4 forestCol = vec4(0.0, 0.5, 0.0, 1.0);","const vec4 mountainCol = vec4(0.3, 0.25, 0.25, 1.0);",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.normalmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"vec2 calculateAlpha() {","if (worldCoord.y < 0.245*64.0) {","/* Sand */ ","return vec2(1.0, 0.0);","} else if (worldCoord.y < 0.255*64.0) {","/* Sand-Grass */","float fade = ((worldCoord.y/64.0)-0.245)*100.0;","return vec2(1.0-fade, fade);","} else {","/* Grass */","return vec2(0.0, 1.0);","}","//return vec2((64.0 - worldCoord.y)/64.0, worldCoord.y/64.0);","}","vec4 calculateColor() {","if (worldCoord.y < 0.2*64.0) { //TODO: Scale as an attribute (check Water too).","/* Water */","return waterCol;","} else if (worldCoord.y < 0.25*64.0) {","/* Sand */","return sandCol;","} else if (worldCoord.y < 0.4*64.0) {","/* Grass */","return grassCol;","} else if (worldCoord.y < 0.5*64.0) {","/*Forest*/","return forestCol;","} else {","/* Mountain */","return mountainCol;","}","}","void main() {","if (worldCoord.y > 0.008 * 64.0) {","vec2 alpha = calculateAlpha();","gl_FragColor = vec4((alpha.x*texture2D(texture0, worldCoord.xz/tex0Scale)","+ alpha.y*texture2D(texture1, worldCoord.xz/tex1Scale)).rgb, opacity);","} else {","gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);","}",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},GAME.namespace("input").init=function(){if("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document){var element=document.body,blocker=document.getElementById("blocker"),instructions=document.getElementById("instructions"),clientForm=document.getElementById("clientForm");GAME.input.pointerLocked=!1;var pointerlockchange=function(){document.pointerLockElement===element||document.mozPointerLockElement===element||document.webkitPointerLockElement===element?(clientForm.input.placeholder="(Press Enter to Chat)",blocker.style.display="none",GAME.input.pointerLocked=!0):(GAME.input.pointerLocked=!1,blocker.style.display="-webkit-box",blocker.style.display="-moz-box",blocker.style.display="box")},pointerlockerror=function(){};document.addEventListener("pointerlockchange",pointerlockchange,!1),document.addEventListener("mozpointerlockchange",pointerlockchange,!1),document.addEventListener("webkitpointerlockchange",pointerlockchange,!1),document.addEventListener("pointerlockerror",pointerlockerror,!1),document.addEventListener("mozpointerlockerror",pointerlockerror,!1),document.addEventListener("webkitpointerlockerror",pointerlockerror,!1);var onBlockerClick=function(){if(instructions.style.display="none",blocker.style.backgroundColor="rgba(0,0,0,0)",document.getElementById("playerWin").style.display="none",clientForm.input.blur(),element.requestPointerLock=element.requestPointerLock||element.mozRequestPointerLock||element.webkitRequestPointerLock,/Firefox/i.test(navigator.userAgent)){var fullscreenchange=function(){(document.fullscreenElement===element||document.mozFullscreenElement===element||document.mozFullScreenElement===element)&&(document.removeEventListener("fullscreenchange",fullscreenchange),document.removeEventListener("mozfullscreenchange",fullscreenchange),element.requestPointerLock())};document.addEventListener("fullscreenchange",fullscreenchange,!1),document.addEventListener("mozfullscreenchange",fullscreenchange,!1),element.requestFullscreen=element.requestFullscreen||element.mozRequestFullscreen||element.mozRequestFullScreen||element.webkitRequestFullscreen,element.requestFullscreen()}else element.requestPointerLock()};blocker.addEventListener("click",onBlockerClick,!1);var blurKeys=[13,73],escDown=!1;document.body.addEventListener("keydown",function(event){GAME.input.pointerLocked?blurKeys.indexOf(event.keyCode)>=0&&(document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock()):27==event.keyCode&&(escDown=!0),13==event.keyCode&&(clientForm.input.placeholder="",clientForm.input.focus()),document.activeElement!=clientForm.input&&73==event.keyCode&&(document.getElementById("playerWin").style.display="")},!1),document.body.addEventListener("keyup",function(event){escDown&&27==event.keyCode&&(onBlockerClick(),escDown=!1)},!1)}var overlay=document.getElementById("overlay"),dragging=null,offX=0,offY=0;overlay.addEventListener("mousedown",function(event){event.target.className.indexOf("draggable")>=0&&(dragging=event.target,offX=event.offsetX,offY=event.offsetY)}),document.addEventListener("mouseup",function(){dragging=null}),document.body.addEventListener("mousemove",function(event){dragging&&(dragging.style.top=event.pageY-offY+"px",dragging.style.left=event.pageX-offX+"px")})},GAME.namespace("audio").context=new webkitAudioContext,GAME.audio.load=function(sources,callback,stream){if(stream){var audio=new Audio;audio.src=sources[0],callback(new GAME.audio.AudioSourceStreaming(audio))}else{var request=new XMLHttpRequest;request.open("GET",sources[0],!0),request.responseType="arraybuffer",request.onload=function(){GAME.audio.context.decodeAudioData(request.response,function(buffer){callback(new GAME.audio.AudioSourceBuffered(buffer))})},request.send()}},GAME.audio.tick=function(delta,game){var camWorldPos=game.camera.localToWorld(new THREE.Vector3),camLookVec=game.camera.localToWorld(new THREE.Vector3(0,0,-1)).sub(camWorldPos).normalize();GAME.audio.context.listener.setPosition(camWorldPos.x,camWorldPos.y,camWorldPos.z),GAME.audio.context.listener.setOrientation(camLookVec.x,camLookVec.y,camLookVec.z,0,1,0)},GAME.audio.AudioSourceBuffered=function(buffer){THREE.Object3D.call(this),this.buffer=buffer,this.panner=GAME.audio.context.createPanner(),this.analyser=GAME.audio.context.createAnalyser(),this.panner.connect(this.analyser),this.analyser.connect(GAME.audio.context.destination)},GAME.audio.AudioSourceBuffered.prototype=Object.create(THREE.Object3D.prototype),GAME.audio.AudioSourceBuffered.prototype.setPosition=function(position){this.panner.setPosition(position.x,position.y,position.z)},GAME.audio.AudioSourceBuffered.prototype.play=function(loop){var source=GAME.audio.context.createBufferSource();source.buffer=this.buffer,source.loop=loop,source.connect(this.panner),source.noteOn(0)},GAME.audio.AudioSourceStreaming=function(audioElement){THREE.Object3D.call(this),this.audioElement=audioElement,this.panner=GAME.audio.context.createPanner(),this.analyser=GAME.audio.context.createAnalyser(),this.panner.connect(this.analyser),this.analyser.connect(GAME.audio.context.destination);var scope=this;setTimeout(function(){var source=GAME.audio.context.createMediaElementSource(scope.audioElement);source.connect(scope.panner),scope.audioElement.addEventListener("ended",function(){source.disconnect()})},0)},GAME.audio.AudioSourceStreaming.prototype=Object.create(THREE.Object3D.prototype),GAME.audio.AudioSourceStreaming.prototype.getAudioFlag=function(flagName){return this.audioElement[flagName]},GAME.audio.AudioSourceStreaming.prototype.setPosition=function(position){this.panner.setPosition(position.x,position.y,position.z)},GAME.audio.AudioSourceStreaming.prototype.setLoop=function(flag){return this.audioElement.loop=flag,this},GAME.audio.AudioSourceStreaming.prototype.play=function(){this.audioElement.play()},GAME.audio.AudioSourceStreaming.prototype.pause=function(){this.audioElement.pause()},GAME.audio.enableTTS=!1,GAME.audio.initMeSpeak=function(){meSpeak.loadConfig("lib/mespeak/mespeak_config.json"),meSpeak.loadVoice("lib/mespeak/voices/en/en.json"),GAME.audio.enableTTS=!0,GAME.audio.loadSpeech("",function(){})},GAME.audio.loadSpeech=function(text,callback,args){GAME.audio.enableTTS&&(args=args||{},args.callback=callback||function(audioElement){audioElement.play()},meSpeak.speak(text,args))},GAME.namespace("models").load=function(models,callback){function loadModel(path){var model=GAME.namespace("models."+path);for(var key in model)return;loaderJSON.load("res/models/"+path.replace(".","/")+".js",function(geometry,materials){model.geom=geometry,model.mats=materials,countdown.dec()})}if(void 0===models||models.length<1)return callback(),void 0;for(var countdown=new GAME.utils.Countdown(models.length,callback),loaderJSON=new THREE.JSONLoader,i=0,len=models.length;len>i;i++)loadModel(models[i])},GAME.namespace("world").Scene=function(game,name,onload){function initScene(scene){scene=eval(scene);var grav=scene.gravity||[0,-9.81,0],countdown2=new GAME.utils.Countdown(3,function(){var player=game.player=self.player=new GAME.player.Player(self);switch(player.position.fromArray(scene.player.position||[0,0,0]),scene.player.controller){case"firstperson":game.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.01,1e4),player.controller=new GAME.player.PlayerController(self,player,game.camera)}player.tick=function(delta){this.controller.update(delta),this.scene.entityManager.tickQueue.add(this)},self.entityManager.tickQueue.add(player),self.add(player),scene.init.call(self),countdown1.dec()});GAME.models.load(scene.models,function(){countdown2.dec()}),GAME.entities.load(scene.entities,function(){countdown2.dec()}),countdown2.dec()}Physijs.Scene.call(this);var countdown1=new GAME.utils.Countdown(2,function(){onload()});this.addEventListener("ready",function(){console.log("Physics Engine initialised."),countdown1.dec()}),this.entityManager=new GAME.entities.EntityManager(this);var self=this;name in GAME.namespace("scenes")?initScene():GAME.utils.xhrAsyncGet("res/scenes/"+name+".js",initScene)},GAME.world.Scene.prototype=Object.create(Physijs.Scene.prototype),GAME.world.Scene.prototype.add=function(entity){Physijs.Scene.prototype.add.call(this,entity),"onSpawn"in entity&&entity.onSpawn()},GAME.world.Scene.prototype.remove=function(entity){Physijs.Scene.prototype.remove.call(this,entity)},GAME.world.Scene.prototype.tick=function(delta){this.entityManager.tick(delta)},GAME.world.Scene.prototype.animate=function(delta){this.entityManager.animate(delta)},GAME.namespace("entities").load=function(entities,callback){function loadEntity(path){var entity=GAME.namespace("entities."+path);for(var key in entity)return;GAME.utils.xhrAsyncGet("res/entities/"+path.replace(".","/")+".js",function(js){eval(js),countdown.dec()})}if(void 0===entities||entities.length<1)return callback(),void 0;for(var countdown=new GAME.utils.Countdown(entities.length,callback),i=0,len=entities.length;len>i;i++)loadEntity(entities[i])},GAME.entities.EntityManager=function(scene){this.scene=scene,this.players={},this.tickQueue=new GAME.utils.List,this.animQueue=new GAME.utils.List},GAME.entities.EntityManager.prototype.spawnPlayer=function(username,state){this.players[username]=new GAME.player.Player(this.scene).addModel(),this.players[username].serverState=state,this.players[username].position.copy(state.pos),this.players[username].rotation.copy(state.rot),this.tickQueue.add(this.players[username]),this.scene.add(this.players[username])},GAME.entities.EntityManager.prototype.despawnPlayer=function(username){this.scene.remove(this.players[username]),this.players[username].despawned=!0,delete this.players[username]},GAME.entities.EntityManager.prototype.tick=function(delta){for(var i=0,size=this.tickQueue.size;size>i;i++)this.tickQueue.poll().tick(delta)},GAME.entities.EntityManager.prototype.animate=function(delta){for(var i=0,size=this.animQueue.size;size>i;i++)this.animQueue.poll().animate(delta);this.scene.simulate(delta)},GAME.namespace("animation").Skeleton=function(mesh){function addBones(root){var bone=new THREE.Object3D;bone.name=root.name,bone.position=root.position,bone.quaternion=root.quaternion,bone.scale=root.scale,this.add(bone),boneMap[bone.name]=bone;for(var i=0,len=root.children.length;len>i;i++)addBones.call(bone,root.children[i])}if(!mesh.hasOwnProperty("bones")||!mesh.bones||!mesh.bones.length)throw new Error("Invalid argument; mesh has no bones.");THREE.Object3D.call(this);for(var boneMap=this.boneMap={},i=0,len=mesh.bones.length;len>i;i++)mesh.bones[i].parent instanceof THREE.Bone||addBones.call(this,mesh.bones[i])},GAME.animation.Skeleton.prototype=Object.create(THREE.Object3D.prototype),GAME.namespace("player").Player=function(scene){THREE.Object3D.call(this),this.scene=scene;var bodyRig=this.bodyRig=new THREE.Object3D;bodyRig.position.y=-.92,bodyRig.rotation.y=Math.PI;for(var bodyMesh=this.mesh=new THREE.SkinnedMesh(GAME.models.player.body.geom,new THREE.MeshFaceMaterial(GAME.models.player.body.mats)),mats=bodyMesh.material.materials,i=0,length=mats.length;length>i;i++){var mat=mats[i];mat.skinning=!0}bodyRig.add(bodyMesh);for(var i=0;i<bodyMesh.geometry.animation.length;i++)THREE.AnimationHandler.add(bodyMesh.geometry.animation[i]);this.animations={pose:new THREE.Animation(bodyMesh,"pose",THREE.AnimationHandler.CATMULLROM),idle:new THREE.Animation(bodyMesh,"idle",THREE.AnimationHandler.CATMULLROM),walk:new THREE.Animation(bodyMesh,"walk",THREE.AnimationHandler.CATMULLROM),chop:new THREE.Animation(bodyMesh,"chop",THREE.AnimationHandler.CATMULLROM)},this.skeleton=new GAME.animation.Skeleton(bodyMesh),bodyRig.add(this.skeleton);var mesh=new THREE.Mesh(GAME.models.player.head.geom,new THREE.MeshFaceMaterial(GAME.models.player.head.mats));
this.head=new THREE.Object3D,this.head.add(mesh),this.skeleton.boneMap.head.add(this.head),this.add(bodyRig),this.animation=this.animations.idle,this.animation.play(),this.despawned=!1},GAME.player.Player.prototype=Object.create(THREE.Object3D.prototype),GAME.player.Player.prototype.playAnimation=function(name,loop,startTimeMS){this.animation.stop(),this.animation=this.animations[name],this.animation.play(loop,startTimeMS)},GAME.player.Player.prototype.onStateReceived=function(state){this.serverState=state},GAME.player.Player.prototype.setHeldItem=function(itemName){itemName?"axeItem"==itemName&&(this.heldItem=this.axe,this.axe.mesh.visible=!0):(this.heldItem=null,this.axe.mesh.visible=!1)},GAME.player.Player.prototype.tick=function(){if(!this.despawned){var linearVelocity=(new THREE.Vector3).copy(this.serverState.pos).sub(this.position),dist=linearVelocity.length();.01>dist?this.position.copy(this.serverState.pos):1>dist?this.position.add(linearVelocity.multiplyScalar(.1)):this.position.add(linearVelocity.normalize().multiplyScalar(.1));var angularVelocity=(new THREE.Vector3).copy(this.serverState.rot).sub(this.rotation);dist=angularVelocity.length(),.01>dist?this.rotation.copy(this.serverState.rot):this.rotation.add(angularVelocity.multiplyScalar(.1)),this.scene.entityManager.tickQueue.add(this)}},GAME.player.PlayerController=function(scene,player,camera){var self=this;player.collider=new Physijs.CapsuleMesh(new THREE.CylinderGeometry(.3,.3,1.8),new THREE.MeshBasicMaterial({visible:!1})),player.collider.position=player.position,player.collider._physijs.collision_flags=16,scene.add(player.collider),player.collider.setAngularFactor(new THREE.Vector3);var camPivotY=new THREE.Object3D;camPivotY.rotation.y=Math.PI,player.skeleton.boneMap.head.add(camPivotY);var camPivotX=new THREE.Object3D;camPivotY.add(camPivotX),this.camRig=new THREE.Object3D,player.mesh.visible=!1,camPivotX.add(this.camRig),document.addEventListener("mousewheel",function(event){GAME.input.pointerLocked&&(self.camRig.position.z-=event.wheelDeltaY/120,self.camRig.position.z=self.camRig.position.z<0?0:self.camRig.position.z>10?10:self.camRig.position.z,player.mesh.visible=self.camRig.position.z>0)}),this.camRig.add(camera);var jumpSphere=player.jumpSphere=new Physijs.SphereMesh(new THREE.SphereGeometry(.1),new THREE.MeshBasicMaterial({visible:!1}));jumpSphere.position.copy(player.collider.position),jumpSphere.position.y-=.85,jumpSphere._physijs.collision_flags=4;var landingSound;GAME.audio.load(["res/audio/landing.ogg"],function(source){landingSound=source}),jumpSphere.addEventListener("collision",function(){landingSound&&landingSound.play(!1)}),scene.add(jumpSphere);var consJump=new Physijs.DOFConstraint(player.collider,jumpSphere,(new THREE.Vector3).copy(jumpSphere.position));scene.addConstraint(consJump);var interactShape=player.interactShape=new Physijs.CylinderMesh(new THREE.CylinderGeometry(.5,.5,2),new THREE.MeshBasicMaterial({visible:!1}));interactShape.position.copy(player.collider.position),interactShape.position.z-=1,interactShape._physijs.collision_flags=4,scene.add(interactShape),new THREE.Vector3(0,0,-1),scene.addEventListener("update",function(){player.interactShape.position.copy(player.localToWorld(new THREE.Vector3(0,.34,-.8))),player.interactShape.__dirtyPosition=!0});var moveForward=!1,moveBackward=!1,moveLeft=!1,moveRight=!1,jump=!1,spacePressed=!1,velocity=new THREE.Vector3,mouseDeltaX=0,mouseDeltaY=0,PI_2=Math.PI/2;document.addEventListener("mousemove",function(event){GAME.input.pointerLocked&&(mouseDeltaX=event.movementX||event.mozMovementX||event.webkitMovementX||0,mouseDeltaY=event.movementY||event.mozMovementY||event.webkitMovementY||0,(mouseDeltaX||mouseDeltaY)&&(camPivotY.rotation.y-=.002*mouseDeltaX,camPivotX.rotation.x-=.002*mouseDeltaY,camPivotX.rotation.x=Math.max(-PI_2,Math.min(PI_2,camPivotX.rotation.x)),(self.camRig.position.z<=0||moveForward||moveBackward||moveLeft||moveRight)&&(player.rotation.y+=camPivotY.rotation.y-Math.PI,camPivotY.rotation.y=Math.PI)))},!1),document.addEventListener("keydown",function(event){switch(event.keyCode){case 38:case 87:moveForward=!0;break;case 37:case 65:moveLeft=!0;break;case 40:case 83:moveBackward=!0;break;case 39:case 68:moveRight=!0;break;case 32:!spacePressed&&player.jumpSphere._physijs.touches.length>1&&(jump=!0),spacePressed=!0;break;case 66:if(!GAME.input.pointerLocked)return;var ball=new Physijs.SphereMesh(new THREE.SphereGeometry(.1,8,8),new THREE.MeshPhongMaterial({color:255})),headWorldPos=camPivotX.localToWorld(new THREE.Vector3(0,0,-1));ball.position.copy(headWorldPos),ball.castShadow=!0,ball.receiveShadow=!0,scene.add(ball),ball.setLinearVelocity(camPivotX.localToWorld(new THREE.Vector3(0,0,-2)).sub(headWorldPos).normalize().multiplyScalar(20));break;case 86:self.camRig.add(GAME.game.camera)}},!1),document.addEventListener("keyup",function(event){switch(event.keyCode){case 38:case 87:moveForward=!1;break;case 37:case 65:moveLeft=!1;break;case 40:case 83:moveBackward=!1;break;case 39:case 68:moveRight=!1;break;case 32:spacePressed=!1}},!1);var rayCasterPick=new THREE.Raycaster;document.addEventListener("mousedown",function(event){GAME.input.pointerLocked&&player.heldItem&&"onMousedown"in player.heldItem&&player.heldItem.onMousedown(event);for(var i=0,len=player.interactShape._physijs.touches.length;len>i;i++){var interactee=scene._objects[player.interactShape._physijs.touches[i]];"onInteract"in interactee&&interactee.onInteract.call(interactee)}var headPos=player.head.localToWorld(new THREE.Vector3);rayCasterPick.ray.origin=headPos,rayCasterPick.ray.direction.copy(player.head.localToWorld(new THREE.Vector3(0,0,-1)).sub(headPos).normalize());for(var intersections=rayCasterPick.intersectObject(scene,!0),i=0,len=intersections.length;len>i&&!(intersections[i].distance>1.5);i++)if(intersections[i].object.visible||"onPick"in intersections[i].object){var pickee=intersections[i].object;"onPick"in pickee&&pickee.onPick.call(pickee,intersections[i]);break}},!1),document.addEventListener("mouseup",function(event){GAME.input.pointerLocked&&player.heldItem&&"onMouseup"in player.heldItem&&player.heldItem.onMouseup(event)},!1);var netTimer=0;this.update=function(delta){if(GAME.input.pointerLocked){delta*=100,moveForward&&(velocity.z-=delta),moveBackward&&(velocity.z+=delta),moveLeft&&(velocity.x-=delta),moveRight&&(velocity.x+=delta);var horiDamping=1-.2*delta,inputV=camPivotY.localToWorld(velocity).sub(camPivotY.localToWorld(new THREE.Vector3)),finalV=(new THREE.Vector3).copy(player.collider.getLinearVelocity()).multiply(new THREE.Vector3(horiDamping,1,horiDamping)).add(inputV);jump&&(finalV.y=4,jump=!1),player.collider.setLinearVelocity(finalV);var moving=moveForward||moveBackward||moveLeft||moveRight;(self.camRig.position.z<=0||moving)&&(player.rotation.y+=camPivotY.rotation.y-Math.PI,camPivotY.rotation.y=Math.PI),moving?("walk"===player.state&&player.animation.isPlaying||player.playAnimation("walk"),player.state="walk"):("idle"!==player.state&&player.playAnimation("idle"),player.state="idle"),velocity.set(0,0,0),netTimer+=delta,netTimer>=1e3&&(GAME.net.p2p.send("state",{pos:player.position.toArray(),rot:player.rotation.toArray()}),netTimer=0)}}},function(){function init(){Physijs.scripts.worker="./lib/physics/physijs_worker.js",Physijs.scripts.ammo="./ammo.js",GAME.input.init(),game.renderer=new THREE.WebGLRenderer({antialias:!0}),game.renderer.setSize(window.innerWidth,window.innerHeight),game.renderer.shadowMapEnabled=!0,game.renderer.shadowMapSoft=!0,game.renderer.sortObjects=!1,GAME.gui.init(),window.addEventListener("resize",function(){game.camera&&(game.camera.aspect=window.innerWidth/window.innerHeight,game.camera.updateProjectionMatrix()),game.renderer.setSize(window.innerWidth,window.innerHeight)},!1),document.getElementById("game").insertBefore(game.renderer.domElement,document.getElementById("overlay")),game.joinScene("island",function(){setTimeout(tick,TICK_INTERVAL_MS),requestAnimationFrame(render)})}function tick(){setTimeout(tick,TICK_INTERVAL_MS),GAME.gui.statsTick.begin();var delta=tickClock.getDelta();game.scene.tick(delta,game),GAME.audio.tick(delta,game),GAME.gui.statsTick.end()}function render(){requestAnimationFrame(render),GAME.gui.statsRender.begin();var delta=animClock.getDelta();TWEEN.update(),THREE.AnimationHandler.update(delta),game.scene.animate(delta,game),game.renderer.render(game.scene,game.camera),GAME.gui.statsRender.end()}var TICK_INTERVAL_MS=1e3/60,game=GAME.game=this;game.setLoadingText=function(text){console.log("> "+text);var loadingDiv=document.getElementById("loadingText");loadingDiv.innerHTML=text,GAME.utils.centerElement(loadingDiv)},game.joinScene=function(name,onJoin){var loadingScreen=document.getElementById("loadingScreen");loadingScreen.style.display="",game.setLoadingText("Loading Scene..."),game.scene=new GAME.world.Scene(game,name,function(){loadingScreen.style.display="none",onJoin()})};var tickClock=new THREE.Clock,animClock=new THREE.Clock;this.main=function(){init()}}.apply(GAME.namespace("core.Main"));
//# sourceMappingURL=game.min.js.map